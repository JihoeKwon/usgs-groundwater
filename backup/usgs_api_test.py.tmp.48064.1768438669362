"""
USGS NWIS API Connection Test
- Only verify if API call works properly
"""

import requests

def test_api_connection():
    """Test API connection"""

    base_url = "https://waterservices.usgs.gov/nwis/dv/"

    # Test with a single known site for faster response
    params = {
        'format': 'json',
        'sites': '323527117050001',  # Active CA groundwater site
        'parameterCd': '72019',      # Depth to water level
        'period': 'P7D',
        'siteStatus': 'all'
    }

    print("=" * 60)
    print("USGS NWIS API Connection Test")
    print("=" * 60)
    print(f"\nURL: {base_url}")
    print(f"Parameters: {params}")
    print("\nSending request... (timeout: 30s)")

    try:
        response = requests.get(base_url, params=params, timeout=30)

        print(f"\n[Response Status]")
        print(f"  Status Code: {response.status_code}")
        print(f"  Content-Type: {response.headers.get('Content-Type', 'N/A')}")

        if response.status_code == 200:
            data = response.json()

            # Check data structure - USGS API returns 'value' as an object with 'timeSeries'
            value_obj = data.get('value', {})

            # Try both possible structures
            if isinstance(value_obj, dict):
                time_series = value_obj.get('timeSeries', [])
            else:
                time_series = value_obj  # Legacy format

            print(f"\n[Data Summary]")
            print(f"  Time series count: {len(time_series)}")

            if time_series:
                # Find time series with actual data
                for ts in time_series:
                    site_info = ts.get('sourceInfo', {})
                    site_codes = site_info.get('siteCode', [])
                    site_code = site_codes[0].get('value', 'N/A') if site_codes else 'N/A'
                    site_name = site_info.get('siteName', 'N/A')

                    values = ts.get('values', [])
                    if values and len(values) > 0:
                        value_list = values[0].get('value', [])
                        # Filter valid values (exclude -999999)
                        valid_values = [v for v in value_list if float(v.get('value', -999999)) > -9999]

                        if valid_values:
                            print(f"\n[Site with Data]")
                            print(f"  Site Code: {site_code}")
                            print(f"  Site Name: {site_name}")
                            print(f"  Measurement count: {len(valid_values)}")

                            # Latest measurement
                            latest = max(valid_values, key=lambda x: x['dateTime'])
                            print(f"  Latest: {latest.get('value')} ft @ {latest.get('dateTime')[:10]}")
                            break
                else:
                    print("\n[Note] No valid measurements in response")

            print("\n" + "=" * 60)
            print("API CONNECTION SUCCESSFUL!")
            print("=" * 60)
            return True

        else:
            print(f"\nAPI Error: {response.status_code}")
            print(response.text[:500])
            return False

    except requests.exceptions.Timeout:
        print("\nTimeout error (exceeded 30 seconds)")
        return False
    except requests.exceptions.ConnectionError as e:
        print(f"\nConnection error: {e}")
        return False
    except Exception as e:
        print(f"\nError occurred: {type(e).__name__}: {e}")
        return False


if __name__ == "__main__":
    test_api_connection()
