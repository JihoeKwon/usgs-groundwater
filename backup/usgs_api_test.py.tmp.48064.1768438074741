"""
USGS NWIS API Connection Test
- Only verify if API call works properly
"""

import requests

def test_api_connection():
    """Test API connection"""

    base_url = "https://waterservices.usgs.gov/nwis/gwlevels/"

    # Test with a single known site for faster response
    params = {
        'format': 'json',
        'sites': '365543119204701',  # Known CA groundwater site
        'period': 'P7D',
        'siteStatus': 'all'
    }

    print("=" * 60)
    print("USGS NWIS API Connection Test")
    print("=" * 60)
    print(f"\nURL: {base_url}")
    print(f"Parameters: {params}")
    print("\nSending request... (timeout: 30s)")

    try:
        response = requests.get(base_url, params=params, timeout=30)

        print(f"\n[Response Status]")
        print(f"  Status Code: {response.status_code}")
        print(f"  Content-Type: {response.headers.get('Content-Type', 'N/A')}")

        if response.status_code == 200:
            data = response.json()

            # Check data structure
            value = data.get('value', [])
            print(f"\n[Data Summary]")
            print(f"  Total sites returned: {len(value)}")

            if value:
                # Sample first site info
                first_site = value[0]
                site_info = first_site.get('sourceInfo', {})
                site_code = site_info.get('siteCode', [{}])[0].get('value', 'N/A')
                site_name = site_info.get('siteName', 'N/A')

                print(f"\n[Sample Site]")
                print(f"  Site Code: {site_code}")
                print(f"  Site Name: {site_name[:50]}..." if len(site_name) > 50 else f"  Site Name: {site_name}")

                # Check measurements
                values = first_site.get('values', [])
                if values and values[0].get('value'):
                    measurement_count = len(values[0]['value'])
                    print(f"  Measurement count: {measurement_count}")

                    # First measurement sample
                    first_value = values[0]['value'][0]
                    print(f"  Sample value: {first_value.get('value')} ft @ {first_value.get('dateTime')}")

            print("\n" + "=" * 60)
            print("API CONNECTION SUCCESSFUL!")
            print("=" * 60)
            return True

        else:
            print(f"\nAPI Error: {response.status_code}")
            print(response.text[:500])
            return False

    except requests.exceptions.Timeout:
        print("\nTimeout error (exceeded 30 seconds)")
        return False
    except requests.exceptions.ConnectionError as e:
        print(f"\nConnection error: {e}")
        return False
    except Exception as e:
        print(f"\nError occurred: {type(e).__name__}: {e}")
        return False


if __name__ == "__main__":
    test_api_connection()
