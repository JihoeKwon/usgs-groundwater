"""
USGS NWIS API - California Central Valley Groundwater Data Collection
Final Production Version
"""

import requests
import pandas as pd
from datetime import datetime, timedelta
import time


class USGSGroundwaterAPI:
    """USGS Groundwater Data Collection Client"""

    def __init__(self):
        self.base_url = "https://waterservices.usgs.gov/nwis"

    def get_recent_groundwater_data(self, state_code="CA", days=7, max_sites=50):
        """
        Query monitoring stations with recent groundwater data

        Parameters:
        -----------
        state_code : str
            State code
        days : int
            Number of days of recent data
        max_sites : int
            Maximum number of sites

        Returns:
        --------
        dict : {'sites': DataFrame, 'data': DataFrame}
        """
        url = f"{self.base_url}/gwlevels/"

        params = {
            'format': 'json',
            'stateCd': state_code,
            'period': f'P{days}D',
            'siteStatus': 'all'
        }

        print(f"API Request: {url}")
        print(f"Parameters: {params}")
        print(f"Sending request... (this may take a while)")

        try:
            response = requests.get(url, params=params, timeout=120)
            response.raise_for_status()

            data = response.json()

            # 측정소 및 데이터 추출
            sites_list = []
            data_list = []

            value = data.get('value', [])

            if not value:
                print("데이터를 찾을 수 없습니다.")
                return {'sites': pd.DataFrame(), 'data': pd.DataFrame()}

            print(f"\n{len(value)}개 측정소 데이터 처리 중...")

            for i, site_data in enumerate(value[:max_sites], 1):
                try:
                    # 측정소 정보
                    site_info = site_data['sourceInfo']
                    site_code = site_info['siteCode'][0]['value']
                    site_name = site_info.get('siteName', 'N/A')

                    geo = site_info['geoLocation']['geogLocation']
                    lat = geo.get('latitude', 0)
                    lon = geo.get('longitude', 0)

                    # 측정소 기록
                    sites_list.append({
                        'site_no': site_code,
                        'site_name': site_name,
                        'latitude': lat,
                        'longitude': lon
                    })

                    # 수위 데이터
                    values = site_data.get('values', [])
                    if values and len(values) > 0:
                        for value_obj in values[0].get('value', []):
                            try:
                                data_list.append({
                                    'site_no': site_code,
                                    'datetime': value_obj['dateTime'],
                                    'water_level_ft': float(value_obj['value']) if value_obj['value'] else None
                                })
                            except (ValueError, KeyError):
                                continue

                    if i % 10 == 0:
                        print(f"  {i}/{min(len(value), max_sites)} 처리됨...")

                except (KeyError, IndexError) as e:
                    continue

            sites_df = pd.DataFrame(sites_list)
            data_df = pd.DataFrame(data_list)

            if not data_df.empty:
                data_df['datetime'] = pd.to_datetime(data_df['datetime'])
                data_df = data_df.sort_values(['site_no', 'datetime'])

            print(f"\n✓ 총 {len(sites_df)}개 측정소")
            print(f"✓ 총 {len(data_df)}개 데이터 포인트")

            return {'sites': sites_df, 'data': data_df}

        except requests.exceptions.Timeout:
            print("⚠ 타임아웃 발생. 기간을 줄이거나 나중에 다시 시도하세요.")
            return {'sites': pd.DataFrame(), 'data': pd.DataFrame()}
        except Exception as e:
            print(f"에러 발생: {e}")
            return {'sites': pd.DataFrame(), 'data': pd.DataFrame()}

    def get_site_history(self, site_no, start_date=None, end_date=None, days=365):
        """
        특정 측정소의 과거 데이터 조회

        Parameters:
        -----------
        site_no : str
            측정소 번호
        start_date : str
            시작일 (YYYY-MM-DD)
        end_date : str
            종료일 (YYYY-MM-DD)
        days : int
            최근 며칠 (start_date/end_date가 없을 경우)

        Returns:
        --------
        DataFrame
        """
        url = f"{self.base_url}/gwlevels/"

        params = {
            'format': 'json',
            'sites': site_no,
            'siteStatus': 'all'
        }

        if start_date and end_date:
            params['startDT'] = start_date
            params['endDT'] = end_date
        else:
            params['period'] = f'P{days}D'

        print(f"\n측정소 {site_no} 데이터 조회 중...")

        try:
            response = requests.get(url, params=params, timeout=60)
            response.raise_for_status()

            data = response.json()
            records = []

            for site_data in data.get('value', []):
                site_info = site_data['sourceInfo']
                values = site_data.get('values', [])

                if values and len(values) > 0:
                    for value_obj in values[0].get('value', []):
                        try:
                            records.append({
                                'datetime': value_obj['dateTime'],
                                'water_level_ft': float(value_obj['value']) if value_obj['value'] else None,
                                'site_no': site_info['siteCode'][0]['value'],
                                'site_name': site_info.get('siteName', 'N/A')
                            })
                        except (ValueError, KeyError):
                            continue

            df = pd.DataFrame(records)
            if not df.empty:
                df['datetime'] = pd.to_datetime(df['datetime'])
                df = df.sort_values('datetime')

            return df

        except Exception as e:
            print(f"에러 발생: {e}")
            return pd.DataFrame()


def main():
    """실행 예제"""

    print("=" * 80)
    print("USGS NWIS API - 캘리포니아 지하수 데이터 수집")
    print("=" * 80)

    client = USGSGroundwaterAPI()

    # 1. 최근 30일간 데이터가 있는 캘리포니아 지하수 측정소 조회
    print("\n[1] 캘리포니아 지하수 측정소 및 최근 데이터 조회")
    print("-" * 80)

    result = client.get_recent_groundwater_data(
        state_code="CA",
        days=30,
        max_sites=100  # 처음 100개 측정소만
    )

    sites_df = result['sites']
    data_df = result['data']

    if not sites_df.empty:
        print(f"\n✓ 측정소 정보 샘플:")
        print(sites_df.head(10))

        # 측정소 정보 저장
        sites_df.to_csv('ca_groundwater_sites.csv', index=False, encoding='utf-8-sig')
        print(f"\n✓ 파일 저장: ca_groundwater_sites.csv")

    if not data_df.empty:
        print(f"\n✓ 지하수 수위 데이터 샘플:")
        print(data_df.head(10))

        # 데이터 저장
        data_df.to_csv('ca_groundwater_levels.csv', index=False, encoding='utf-8-sig')
        print(f"\n✓ 파일 저장: ca_groundwater_levels.csv")

        # 측정소별 통계
        stats = data_df.groupby('site_no')['water_level_ft'].agg([
            ('측정수', 'count'),
            ('평균_ft', 'mean'),
            ('최소_ft', 'min'),
            ('최대_ft', 'max'),
            ('표준편차', 'std')
        ]).round(2)

        print(f"\n✓ 측정소별 통계:")
        print(stats.head(10))

        stats.to_csv('ca_groundwater_stats.csv', encoding='utf-8-sig')
        print(f"\n✓ 파일 저장: ca_groundwater_stats.csv")

        # 2. 샘플 측정소의 상세 이력 조회
        if len(sites_df) > 0:
            sample_site = sites_df.iloc[0]['site_no']

            print(f"\n[2] 샘플 측정소 {sample_site}의 최근 1년 데이터")
            print("-" * 80)

            history_df = client.get_site_history(sample_site, days=365)

            if not history_df.empty:
                print(f"\n✓ 총 {len(history_df)}개 데이터 포인트")
                print(f"\n최근 10개 데이터:")
                print(history_df.tail(10))

                history_df.to_csv(f'site_{sample_site}_history.csv', index=False, encoding='utf-8-sig')
                print(f"\n✓ 파일 저장: site_{sample_site}_history.csv")

    print("\n" + "=" * 80)
    print("완료!")
    print("=" * 80)
    print("\n생성된 파일:")
    print("  - ca_groundwater_sites.csv: 측정소 정보")
    print("  - ca_groundwater_levels.csv: 지하수 수위 데이터")
    print("  - ca_groundwater_stats.csv: 측정소별 통계")
    if not sites_df.empty:
        print(f"  - site_{sites_df.iloc[0]['site_no']}_history.csv: 샘플 측정소 이력")


if __name__ == "__main__":
    main()
